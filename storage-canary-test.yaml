# Canary Test for Persistent Volume Provisioning
# Based on multi-model consensus validation
# Tests persistence across pod restarts before deploying actual services

---
# Test PVC for database storage class
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: database-canary-pvc
  labels:
    app.kubernetes.io/name: data-ingestion-pipeline
    app.kubernetes.io/component: storage-test
    test-type: database-canary
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: database-local-path
  resources:
    requests:
      storage: 100Mi

---
# Test PVC for streaming storage class
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: streaming-canary-pvc
  labels:
    app.kubernetes.io/name: data-ingestion-pipeline
    app.kubernetes.io/component: storage-test
    test-type: streaming-canary
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: streaming-local-path
  resources:
    requests:
      storage: 100Mi

---
# Test PVC for metadata storage class
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: metadata-canary-pvc
  labels:
    app.kubernetes.io/name: data-ingestion-pipeline
    app.kubernetes.io/component: storage-test
    test-type: metadata-canary
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: metadata-local-path
  resources:
    requests:
      storage: 50Mi

---
# Database canary test pod
apiVersion: v1
kind: Pod
metadata:
  name: database-canary-test
  labels:
    app.kubernetes.io/name: data-ingestion-pipeline
    app.kubernetes.io/component: storage-test
    test-type: database-canary
spec:
  restartPolicy: Never
  volumes:
    - name: test-storage
      persistentVolumeClaim:
        claimName: database-canary-pvc
  containers:
  - name: test-container
    image: busybox:1.35
    command: 
      - /bin/sh
      - -c
      - |
        echo "Database canary test started at $(date)" | tee /data/test-start.log
        echo "Testing database-optimized storage persistence" > /data/database-test.txt
        echo "Random I/O simulation for database workload" >> /data/database-test.txt
        dd if=/dev/zero of=/data/test-file bs=1M count=10
        sync
        echo "Database canary test data written successfully"
        echo "File contents:" && cat /data/database-test.txt
        echo "Test completed at $(date)" | tee -a /data/test-start.log
        sleep 30
    volumeMounts:
      - name: test-storage
        mountPath: /data
    resources:
      requests:
        memory: "32Mi"
        cpu: "50m"
      limits:
        memory: "64Mi"
        cpu: "100m"

---
# Streaming canary test pod
apiVersion: v1
kind: Pod
metadata:
  name: streaming-canary-test
  labels:
    app.kubernetes.io/name: data-ingestion-pipeline
    app.kubernetes.io/component: storage-test
    test-type: streaming-canary
spec:
  restartPolicy: Never
  volumes:
    - name: test-storage
      persistentVolumeClaim:
        claimName: streaming-canary-pvc
  containers:
  - name: test-container
    image: busybox:1.35
    command: 
      - /bin/sh
      - -c
      - |
        echo "Streaming canary test started at $(date)" | tee /data/test-start.log
        echo "Testing streaming-optimized storage persistence" > /data/streaming-test.txt
        echo "Sequential write simulation for Kafka workload" >> /data/streaming-test.txt
        for i in $(seq 1 100); do echo "Log entry $i: $(date)" >> /data/streaming-test.txt; done
        sync
        echo "Streaming canary test data written successfully"
        echo "Log entries count: $(wc -l < /data/streaming-test.txt)"
        echo "Test completed at $(date)" | tee -a /data/test-start.log
        sleep 30
    volumeMounts:
      - name: test-storage
        mountPath: /data
    resources:
      requests:
        memory: "32Mi"
        cpu: "50m"
      limits:
        memory: "64Mi"
        cpu: "100m"

---
# Metadata canary test pod
apiVersion: v1
kind: Pod
metadata:
  name: metadata-canary-test
  labels:
    app.kubernetes.io/name: data-ingestion-pipeline
    app.kubernetes.io/component: storage-test
    test-type: metadata-canary
spec:
  restartPolicy: Never
  volumes:
    - name: test-storage
      persistentVolumeClaim:
        claimName: metadata-canary-pvc
  containers:
  - name: test-container
    image: busybox:1.35
    command: 
      - /bin/sh
      - -c
      - |
        echo "Metadata canary test started at $(date)" | tee /data/test-start.log
        echo "Testing metadata-optimized storage persistence" > /data/metadata-test.txt
        echo "Small file access simulation for Schema Registry" >> /data/metadata-test.txt
        echo '{"schema": "test", "version": 1}' > /data/schema-test.json
        sync
        echo "Metadata canary test data written successfully"
        echo "Schema file contents:" && cat /data/schema-test.json
        echo "Test completed at $(date)" | tee -a /data/test-start.log
        sleep 30
    volumeMounts:
      - name: test-storage
        mountPath: /data
    resources:
      requests:
        memory: "32Mi"
        cpu: "50m"
      limits:
        memory: "64Mi"
        cpu: "100m"