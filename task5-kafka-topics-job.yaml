apiVersion: batch/v1
kind: Job
metadata:
  name: create-kafka-topics
  namespace: data-ingestion
  labels:
    app: kafka
    component: topic-management
spec:
  template:
    metadata:
      labels:
        app: kafka
        component: topic-management
    spec:
      serviceAccountName: kafka-sa
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      restartPolicy: OnFailure
      containers:
      - name: topic-creator
        image: confluentinc/cp-kafka:7.4.0
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          seccompProfile:
            type: RuntimeDefault
          capabilities:
            drop:
            - ALL
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        command:
        - /bin/bash
        - -c
        - |
          # Wait for Kafka to be ready with timeout
          TIMEOUT=300  # 5 minutes
          ELAPSED=0
          until kafka-topics --bootstrap-server kafka-0.kafka-headless.data-ingestion.svc.cluster.local:9092 --list > /dev/null 2>&1 || [ $ELAPSED -ge $TIMEOUT ]; do
            echo "Waiting for Kafka to be ready... ($ELAPSED seconds elapsed)"
            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done
          
          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "ERROR: Kafka failed to become ready within $TIMEOUT seconds"
            exit 1
          fi
          
          echo "Kafka cluster is ready. Creating topics..."
          
          # Create Kafka Connect internal topics
          echo "Creating connect-configs topic..."
          kafka-topics --bootstrap-server kafka-0.kafka-headless.data-ingestion.svc.cluster.local:9092 \
            --create --if-not-exists \
            --topic connect-configs \
            --partitions 1 \
            --replication-factor 3 \
            --config cleanup.policy=compact \
            --config compression.type=lz4 \
            --config min.insync.replicas=2
          
          echo "Creating connect-offsets topic..."
          kafka-topics --bootstrap-server kafka-0.kafka-headless.data-ingestion.svc.cluster.local:9092 \
            --create --if-not-exists \
            --topic connect-offsets \
            --partitions 25 \
            --replication-factor 3 \
            --config cleanup.policy=compact \
            --config compression.type=lz4 \
            --config min.insync.replicas=2
          
          echo "Creating connect-status topic..."
          kafka-topics --bootstrap-server kafka-0.kafka-headless.data-ingestion.svc.cluster.local:9092 \
            --create --if-not-exists \
            --topic connect-status \
            --partitions 5 \
            --replication-factor 3 \
            --config cleanup.policy=compact \
            --config compression.type=lz4 \
            --config min.insync.replicas=2
          
          # Create Dead Letter Queue topics
          echo "Creating connect-dlq topic..."
          kafka-topics --bootstrap-server kafka-0.kafka-headless.data-ingestion.svc.cluster.local:9092 \
            --create --if-not-exists \
            --topic connect-dlq \
            --partitions 3 \
            --replication-factor 3 \
            --config retention.ms=604800000 \
            --config compression.type=lz4 \
            --config cleanup.policy=delete \
            --config min.insync.replicas=2
          
          echo "Creating s3-sink-dlq topic..."
          kafka-topics --bootstrap-server kafka-0.kafka-headless.data-ingestion.svc.cluster.local:9092 \
            --create --if-not-exists \
            --topic s3-sink-dlq \
            --partitions 3 \
            --replication-factor 3 \
            --config retention.ms=604800000 \
            --config compression.type=lz4 \
            --config cleanup.policy=delete \
            --config min.insync.replicas=2

          echo "Creating __debezium-heartbeat.postgres topic..."
          kafka-topics --bootstrap-server kafka-0.kafka-headless.data-ingestion.svc.cluster.local:9092 \
            --create \
            --topic __debezium-heartbeat.postgres \
            --partitions 6 \
            --replication-factor 3 \
            --config retention.ms=604800000 \
            --config compression.type=lz4 \
            --config cleanup.policy=delete \
            --config min.insync.replicas=2 \
            --if-not-exists

          # Create postgres.transaction topic (for s3-sink-connector)
          echo "Creating postgres.transaction topic..."
          kafka-topics --bootstrap-server kafka-0.kafka-headless.data-ingestion.svc.cluster.local:9092 \
            --create \
            --topic postgres.transaction \
            --partitions 6 \
            --replication-factor 3 \
            --config retention.ms=604800000 \
            --config compression.type=lz4 \
            --config cleanup.policy=delete \
            --config min.insync.replicas=2 \
            --if-not-exists

          echo "Creating postgres.public.users topic..."
          kafka-topics --bootstrap-server kafka-0.kafka-headless.data-ingestion.svc.cluster.local:9092 \
            --create \
            --topic postgres.public.users \
            --partitions 6 \
            --replication-factor 3 \
            --config retention.ms=604800000 \
            --config compression.type=lz4 \
            --config cleanup.policy=delete \
            --config min.insync.replicas=2 \
            --if-not-exists

          echo "Creating postgres.public.products topic..."
          kafka-topics --bootstrap-server kafka-0.kafka-headless.data-ingestion.svc.cluster.local:9092 \
            --create \
            --topic postgres.public.products \
            --partitions 6 \
            --replication-factor 3 \
            --config retention.ms=604800000 \
            --config compression.type=lz4 \
            --config cleanup.policy=delete \
            --config min.insync.replicas=2 \
            --if-not-exists

          echo "Creating postgres.public.orders topic..."
          kafka-topics --bootstrap-server kafka-0.kafka-headless.data-ingestion.svc.cluster.local:9092 \
            --create \
            --topic postgres.public.orders \
            --partitions 6 \
            --replication-factor 3 \
            --config retention.ms=604800000 \
            --config compression.type=lz4 \
            --config cleanup.policy=delete \
            --config min.insync.replicas=2 \
            --if-not-exists

          echo "Creating postgres.public.order_items topic..."
          kafka-topics --bootstrap-server kafka-0.kafka-headless.data-ingestion.svc.cluster.local:9092 \
            --create \
            --topic postgres.public.order_items \
            --partitions 6 \
            --replication-factor 3 \
            --config retention.ms=604800000 \
            --config compression.type=lz4 \
            --config cleanup.policy=delete \
            --config min.insync.replicas=2 \
            --if-not-exists
          
          echo "Verifying created topics..."
          kafka-topics --bootstrap-server kafka-0.kafka-headless.data-ingestion.svc.cluster.local:9092 --list
          
          echo "Topic creation completed successfully!"
